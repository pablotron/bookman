(()=>{"use strict";const r=document,t=a=>r.getElementById(a),f=a=>r.querySelectorAll(a),d=(a,n,s)=>a.addEventListener(n,s),v=t("q"),u=t("books"),m=t("upload"),o=a=>String(a).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll("'","&apos;").replaceAll('"',"&quot;"),p={item:a=>`
      <a
        href='./book/${o(a.id)}'
        class='panel-block'
        title='${o(a.name)}, by ${o(a.author)}'
        aria-label='${o(a.name)}, by ${o(a.author)}'
        data-id='${o(a.id)}'
        data-name='${o(a.name)}'
        data-author='${o(a.author)}'
        data-rank='${o(a.rank)}'
      >
        <span class='edit-book'>
          <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-pencil-square' viewBox='0 0 16 16'>
            <path d='M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z'/>
            <path fill-rule='evenodd' d='M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z'/>
          </svg>
        </span>

        ${o(a.name)}, by ${o(a.author)}
      </a>
    `,none:()=>`
      <div class='panel-block'>
        No matching results.
      </div>
    `,list:a=>a.map(n=>p.item(n)).join("")},h=()=>{const a=v.value||"",n=u.dataset.q||"";if(!a||a!==n){const s="./api/search?"+new URLSearchParams({q:a}).toString();fetch(s).then(i=>i.json()).then(i=>{u.dataset.q=q,u.innerHTML=i.length>0?p.list(i):p.none()})}};d(r,"DOMContentLoaded",()=>{let a=null;d(v,"keydown",()=>{a!==null&&(clearTimeout(a),a=null),a=setTimeout(h,200)}),d(t("books"),"click",e=>{if(e.target.closest(".edit-book")){const l=e.target.closest("a").dataset;return t("edit-save-btn").dataset.id=l.id,t("edit-name").value=l.name,t("edit-author").value=l.author,t("edit-dialog").classList.add("is-active"),e.preventDefault(),!1}}),d(t("edit-save-btn"),"click",e=>{const l=new FormData;return l.append("id",t("edit-save-btn").dataset.id),l.append("name",t("edit-name").value),l.append("author",t("edit-author").value),fetch("./api/edit",{method:"POST",body:l}).then(c=>{if(!c.ok){alert("edit failed");return}t("edit-dialog").classList.remove("is-active"),h()}),e.preventDefault(),e.stopPropagation(),!1}),d(t("upload-btn"),"click",()=>{m.click()}),d(m,"change",()=>{const e=m.files;if(e.length==0)return;console.log(e);let l=new FormData;for(let c of e)l.append("file",c);fetch("./api/upload",{method:"POST",body:l}).then(c=>{c.ok?h():alert("upload failed")})});const n=e=>e.classList.add("is-active"),s=e=>e.classList.remove("is-active"),i=()=>(f(".modal")||[]).forEach(e=>s(e));(f(".modal-background, .modal-close, .modal-card-head .delete, .modal-card-foot")||[]).forEach(e=>{const l=e.closest(".modal");d(e,"click",()=>s(l))}),d(r,"keydown",e=>{(e||window.event).keyCode===27&&i()})}),h()})();
